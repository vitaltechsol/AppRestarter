<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>AppRestarter Web</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
        :root {
            --bg: #0f172a;
            --bg-alt: #020617;
            --card-bg: #111827;
            --accent: #17dbe4;
            --accent-soft: rgba(34, 197, 94, 0.15);
            --danger: #ef4444;
            --text-main: #e5e7eb;
            --text-muted: #9ca3af;
            --title: #ccdde5;
            --border-subtle: #1f2933;
            --nav-width: 80px;
            --radius-xl: 18px;
            --shadow-soft: 0 18px 40px rgba(15, 23, 42, 0.7);
            --transition-fast: 0.16s ease-out;
        }

        * {
            box-sizing: border-box;
        }

        /* NEW: keep document locked to viewport */
        html,
        body {
            height: 100%;
            overflow: hidden; /* only inner panels scroll */
        }

        body {
            margin: 0;
            background: radial-gradient(circle at top, #1f2937 0, #020617 55%, #000 100%);
            color: var(--text-main);
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            display: flex;
            align-items: stretch;
            justify-content: center;
        }

        .shell {
            display: flex;
            flex: 1;
            max-width: 1280px;
            width: 100%;
            padding: 20px;
            gap: 20px;
        }

        /* LEFT NAV */

        .nav {
            width: var(--nav-width);
            background: linear-gradient(180deg, #020617, #030712);
            border-radius: 24px;
            padding: 14px 10px;
            box-shadow: var(--shadow-soft);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(148, 163, 184, 0.12);
        }

        .nav-logo {
            font-weight: 700;
            font-size: 8px;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--text-muted);
        }

        .nav-main,
        .nav-bottom {
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .nav-btn {
            all: unset;
            cursor: pointer;
            width: 50px;
            height: 50px;
            border-radius: 999px;
            display: flex;
            margin: 0 0 24px 0;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            font-size: 22px;
            background: radial-gradient(circle at 30% 30%, rgba(148, 163, 184, 0.15), rgba(15, 23, 42, 0.8));
            border: 1px solid rgba(148, 163, 184, 0.25);
            color: var(--text-muted);
            position: relative;
            transition: transform var(--transition-fast), box-shadow var(--transition-fast), border-color var(--transition-fast), background var(--transition-fast), color var(--transition-fast), opacity 0.15s linear;
        }

            .nav-btn span.label {
                position: absolute;
                bottom: -18px;
                font-size: 12px;
                text-transform: uppercase;
                letter-spacing: 0.14em;
            }

            .nav-btn.active {
                background: radial-gradient(circle at 20% 20%, var(--accent-soft), #020617);
                border-color: var(--accent);
                color: var(--accent);
                box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.35), 0 18px 35px rgba(15, 118, 110, 0.55);
                transform: translateY(-2px) scale(1.03);
            }

            .nav-btn:hover:not(.active) {
                transform: translateY(-1px);
                border-color: rgba(148, 163, 184, 0.6);
            }

            .nav-btn:active {
                transform: translateY(0) scale(0.98);
            }

        /* MAIN AREA */

        .main {
            flex: 1;
            background: radial-gradient(circle at top left, rgba(55, 65, 81, 0.4), rgba(3, 7, 18, 0.95));
            border-radius: 26px;
            padding: 18px 22px 22px;
            box-shadow: var(--shadow-soft);
            border: 1px solid rgba(148, 163, 184, 0.18);
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .main-header {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            gap: 10px;
        }

        .title-block {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

            .title-block h1 {
                margin: 0;
                font-size: 22px;
                font-weight: 600;
                letter-spacing: 0.02em;
            }

            .title-block span {
                font-size: 12px;
                color: var(--text-muted);
            }

        .status-pill {
            padding: 5px 10px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.35);
            font-size: 11px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .dot {
            width: 7px;
            height: 7px;
            border-radius: 999px;
            background: #22c55e;
            box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.35);
        }

        /* TAB BAR (for view title) */

        .tab-bar {
            display: inline-flex;
            background: rgba(15, 23, 42, 0.8);
            border-radius: 999px;
            padding: 3px;
            border: 1px solid rgba(148, 163, 184, 0.2);
            gap: 3px;
        }

        .tab-pill {
            padding: 5px 12px;
            border-radius: 999px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
        }

            .tab-pill.active {
                background: var(--accent-soft);
                color: #bbf7d0;
            }

        /* CONTENT AREA */

        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 12px;
            overflow: hidden;
        }

        .content-inner {
            flex: 1;
            overflow-y: auto;
            padding-right: 6px;
        }

        .section-title-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

            .section-title-row h2 {
                margin: 0;
                font-size: 14px;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.16em;
                color: var(--text-muted);
            }

        /* APPS VIEW */

        .group-list {
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .group-card {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.98), rgba(17, 24, 39, 0.9));
            border-radius: 18px;
            border: 1px solid rgba(148, 163, 184, 0.25);
            padding: 12px 14px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .group-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 6px;
        }

        .group-name {
            font-size: 13px;
            font-weight: 600;
        }

        .group-meta {
            font-size: 11px;
            color: var(--text-muted);
        }

        .btn {
            all: unset;
            cursor: pointer;
            border-radius: 999px;
            padding: 6px 11px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            border: 1px solid rgba(148, 163, 184, 0.3);
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: background var(--transition-fast), color var(--transition-fast), border-color var(--transition-fast), transform 0.08s ease-out;
        }

        .btn-ghost {
            background: transparent;
            color: var(--text-muted);
        }

            .btn-ghost:hover {
                border-color: rgba(148, 163, 184, 0.7);
                color: var(--text-main);
            }

        .btn-accent {
            background: linear-gradient(135deg, #036e73, #00828f);
            border-color: transparent;
            color: #e5f3f5;
            font-weight: 600;
        }

            .btn-accent:hover {
                transform: translateY(-1px);
            }

            .btn-accent:active {
                transform: translateY(0);
            }

        .btn-small {
            padding: 4px 9px;
            font-size: 12px;
            width:
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            border-color: transparent;
            color: #fef2f2;
            font-weight: 600;
        }

            .btn-danger:hover {
                transform: translateY(-1px);
            }

            .btn-danger:active {
                transform: translateY(0);
            }

        .app-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .app-pill {
            background: rgb(35 43 63 / 90%);
            border-radius: 8px;
            padding: 5px 9px;
            border: 1px solid rgba(55, 65, 81, 0.8);
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            width: 312px;
            justify-content: space-between;
        }

        .app-name {
            font-size: 16px;
            font-weight: 500;
            color: var(--title);
        }

        .app-meta {
            font-size: 10px;
            color: var(--text-muted);
        }

        .app-actions {
            display: inline-flex;
            gap: 6px;
            margin-left: 8px;
        }

        /* PCS VIEW */

        .pc-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
            gap: 12px;
        }

        .pc-card {
            background: linear-gradient(145deg, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.92));
            border-radius: 18px;
            border: 1px solid rgba(148, 163, 184, 0.25);
            padding: 12px 14px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            position: relative;
            overflow: hidden;
        }

            .pc-card::before {
                content: "";
                position: absolute;
                inset: -40%;
                background: radial-gradient(circle at 0 0, rgba(34, 197, 94, 0.2), transparent 55%);
                opacity: 0.7;
                pointer-events: none;
            }

        .pc-name {
            font-size: 16px;
            font-weight: 600;
        }

        .pc-ip {
            font-size: 11px;
            color: var(--text-muted);
        }

        .pc-actions {
            display: flex;
            gap: 8px;
            margin-top: 6px;
        }

        /* TOAST / STATUS */

        .toast {
            position: fixed;
            right: 24px;
            bottom: 24px;
            padding: 10px 14px;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.96);
            border: 1px solid rgba(148, 163, 184, 0.6);
            color: var(--text-main);
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--shadow-soft);
            opacity: 0;
            transform: translateY(12px);
            pointer-events: none;
            transition: opacity 0.18s ease-out, transform 0.18s ease-out;
        }

            .toast.visible {
                opacity: 1;
                transform: translateY(0);
                pointer-events: auto;
            }

        .toast-icon {
            font-size: 15px;
        }

        .toast-danger {
            border-color: rgba(248, 113, 113, 0.7);
        }

        /* RESPONSIVE */

        @media (max-width: 768px) {
            .shell {
                padding: 10px;
            }

            .nav {
                width: 70px;
            }

            .main {
                padding: 14px 14px 16px;
            }

            .title-block h1 {
                font-size: 18px;
            }

            .pc-grid {
                grid-template-columns: minmax(0, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="shell">
        <!-- LEFT NAV -->
        <aside class="nav">
            <div class="nav-main">
                <div class="nav-logo">APP<br />RESTARTER</div>
                <button class="nav-btn active" data-view="apps" id="navApps">
                    <div>🗃️</div>
                    <span class="label">Apps</span>
                </button>
                <button class="nav-btn" data-view="pcs" id="navPcs">
                    <div>🖥️</div>
                    <span class="label">PCs</span>
                </button>
            </div>
            <div class="nav-bottom">
                <div style="opacity:0.4; cursor:default; font-size: 9px;">
                    <span class="label">v1.6.0</span>
                </div>
            </div>
        </aside>

        <!-- MAIN -->
        <main class="main">
            <div class="content">
                <div class="content-inner" id="contentApps">
                    <div class="group-list" id="groupList">
                        <!-- Groups + apps rendered here -->
                    </div>
                </div>
                <div class="content-inner" id="contentPcs" style="display:none;">
                    <div class="pc-grid" id="pcGrid">
                        <!-- PCs rendered here -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div class="toast" id="toast">
        <span class="toast-icon" id="toastIcon">✅</span>
        <span id="toastText">Action completed</span>
    </div>

    <script>
        const navApps = document.getElementById('navApps');
        const navPcs = document.getElementById('navPcs');
        const viewTitle = document.getElementById('viewTitle');
        const viewSubtitle = document.getElementById('viewSubtitle');
        const tabLabel = document.getElementById('tabLabel');

        const contentApps = document.getElementById('contentApps');
        const contentPcs = document.getElementById('contentPcs');
        const groupList = document.getElementById('groupList');
        const pcGrid = document.getElementById('pcGrid');

        const toast = document.getElementById('toast');
        const toastText = document.getElementById('toastText');
        const toastIcon = document.getElementById('toastIcon');

        let toastTimeout = null;
        let pcsCache = []; // ✅ store PCs so Apps view can map IP -> PC name

        function showToast(message, isError = false) {
            toastText.textContent = message;
            toastIcon.textContent = isError ? '⚠️' : '✅';
            toast.classList.toggle('toast-danger', isError);
            toast.classList.add('visible');
            if (toastTimeout) clearTimeout(toastTimeout);
            toastTimeout = setTimeout(() => {
                toast.classList.remove('visible');
            }, 3500);
        }

        function setView(view) {
            if (view === 'apps') {
                navApps.classList.add('active');
                navPcs.classList.remove('active');
                contentApps.style.display = '';
                contentPcs.style.display = 'none';
            } else if (view === 'pcs') {
                navPcs.classList.add('active');
                navApps.classList.remove('active');
                contentPcs.style.display = '';
                contentApps.style.display = 'none';
            }
        }

        navApps.addEventListener('click', () => setView('apps'));
        navPcs.addEventListener('click', () => setView('pcs'));

        // --- API HELPERS ---

        async function apiGet(path) {
            const res = await fetch(path, { cache: 'no-store' });
            if (!res.ok) throw new Error(await res.text());
            return res.json();
        }

        async function apiPost(path, body) {
            const res = await fetch(path, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body || {})
            });
            const text = await res.text();
            if (!res.ok) throw new Error(text || `Request failed (${res.status})`);
            return text;
        }

        // --- APPS VIEW ---

        function renderApps(apps) {
            groupList.innerHTML = '';

            if (!apps || apps.length === 0) {
                groupList.innerHTML = '<div style="font-size:12px;color:#9ca3af;">No applications configured yet.</div>';
                return;
            }

            // Group by GroupName (empty => "(Ungrouped)")
            const groupMap = new Map();
            for (const app of apps) {
                const rawGroup = app.GroupName || '';
                const key = rawGroup.trim().length > 0 ? rawGroup.trim() : '(Ungrouped)';
                if (!groupMap.has(key)) groupMap.set(key, []);
                groupMap.get(key).push(app);
            }

            // ✅ Show ungrouped first, then others alphabetically
            const groups = Array.from(groupMap.entries());
            groups.sort((a, b) => {
                const nameA = a[0];
                const nameB = b[0];
                if (nameA === '(Ungrouped)' && nameB !== '(Ungrouped)') return -1;
                if (nameB === '(Ungrouped)' && nameA !== '(Ungrouped)') return 1;
                if (nameA === '(Ungrouped)' && nameB === '(Ungrouped)') return 0;
                return nameA.localeCompare(nameB);
            });

            for (const [groupName, items] of groups) {
                const card = document.createElement('div');
                card.className = 'group-card';

                const header = document.createElement('div');
                header.className = 'group-header';

                const left = document.createElement('div');
                const groupTitle = document.createElement('div');
                groupTitle.className = 'group-name';
                groupTitle.textContent = groupName;
                left.appendChild(groupTitle);

                const right = document.createElement('div');
                const restartGroupBtn = document.createElement('button');
                restartGroupBtn.className = 'btn btn-accent btn-small';
                restartGroupBtn.textContent = 'Restart group';
                restartGroupBtn.addEventListener('click', async () => {
                    if (groupName === '(Ungrouped)') {
                        const confirmMsg = `Restart all ${items.length} ungrouped app(s)?`;
                        if (!confirm(confirmMsg)) return;
                        try {
                            for (const app of items) {
                                await apiPost('/restart', { Name: app.Name });
                            }
                            showToast(`Restarted ${items.length} app(s).`);
                        } catch (err) {
                            console.error(err);
                            showToast('Failed to restart apps.', true);
                        }
                    } else {
                        const confirmMsg = `Restart all ${items.length} app(s) in group "${groupName}"?`;
                        if (!confirm(confirmMsg)) return;
                        try {
                            const msg = await apiPost('/restart-group', { GroupName: groupName });
                            showToast(msg);
                        } catch (err) {
                            console.error(err);
                            showToast('Failed to restart group.', true);
                        }
                    }
                });

                right.appendChild(restartGroupBtn);
                header.appendChild(left);
                header.appendChild(right);

                const appListEl = document.createElement('div');
                appListEl.className = 'app-list';

                for (const app of items) {
                    const pill = document.createElement('div');
                    pill.className = 'app-pill';

                    const textWrap = document.createElement('div');
                    const nameEl = document.createElement('div');
                    nameEl.className = 'app-name';
                    nameEl.textContent = app.Name;

                    const metaEl = document.createElement('div');
                    metaEl.className = 'app-meta';

                    // ✅ Map IP -> PC Name (if found in pcsCache)
                    let clientInfo;
                    if (app.ClientIP) {
                        const pc = pcsCache.find(p => p.IP === app.ClientIP);
                        const label = pc ? pc.Name : app.ClientIP;
                        clientInfo = `${label}`;
                    } else {
                        clientInfo = 'Local';
                    }

                    metaEl.textContent = `${app.ProcessName ? app.ProcessName + ' ·' : ''}${clientInfo}`;
                    textWrap.appendChild(nameEl);
                    textWrap.appendChild(metaEl);

                    const actions = document.createElement('div');
                    actions.className = 'app-actions';

                    // Restart button
                    const restartBtn = document.createElement('button');
                    restartBtn.className = 'btn btn-ghost btn-small';
                    restartBtn.textContent = 'Restart';
                    restartBtn.addEventListener('click', async () => {
                        // Skip confirm if NoWarn is true
                        if (!app.NoWarn) {
                            const confirmMsg = `Restart "${app.Name}"?`;
                            if (!confirm(confirmMsg)) return;
                        }
                        try {
                            await apiPost('/restart', { Name: app.Name });
                            showToast(`Restart sent to "${app.Name}".`);
                        } catch (err) {
                            console.error(err);
                            showToast(`Failed to restart "${app.Name}".`, true);
                        }
                    });

                    // Stop button
                    const stopBtn = document.createElement('button');
                    stopBtn.className = 'btn btn-ghost btn-small';
                    stopBtn.textContent = 'Stop';
                    stopBtn.addEventListener('click', async () => {
                        if (!app.NoWarn) {
                            const confirmMsg = `Stop "${app.Name}"?`;
                            if (!confirm(confirmMsg)) return;
                        }

                        try {
                            await apiPost('/stop', { Name: app.Name });
                            showToast(`Stop sent to "${app.Name}".`);
                        } catch (err) {
                            console.error(err);
                            showToast(`Failed to stop "${app.Name}".`, true);
                        }
                    });

                    actions.appendChild(restartBtn);
                    actions.appendChild(stopBtn);;

                    pill.appendChild(textWrap);
                    pill.appendChild(actions);
                    appListEl.appendChild(pill);
                }

                card.appendChild(header);
                card.appendChild(appListEl);
                groupList.appendChild(card);
            }
        }

        async function loadApps() {
            try {
                const apps = await apiGet('/apps');
                renderApps(apps);
            } catch (err) {
                console.error(err);
                showToast('Failed to load apps list.', true);
            }
        }

        // --- PCS VIEW ---

        function renderPcs(pcs) {
            pcGrid.innerHTML = '';

            if (!pcs || pcs.length === 0) {
                pcGrid.innerHTML = '<div style="font-size:12px;color:#9ca3af;">No PCs configured yet.</div>';
                return;
            }

            // ✅ "All" card to restart/shutdown all PCs
            const allCard = document.createElement('div');
            allCard.className = 'pc-card';

            const allName = document.createElement('div');
            allName.className = 'pc-name';
            allName.textContent = 'All PCs';

            const allDesc = document.createElement('div');
            allDesc.className = 'pc-ip';
            allDesc.textContent = 'All configured PC.';

            const allActions = document.createElement('div');
            allActions.className = 'pc-actions';

            const allRestartBtn = document.createElement('button');
            allRestartBtn.className = 'btn btn-ghost btn-small';
            allRestartBtn.textContent = 'Restart';
            allRestartBtn.addEventListener('click', async () => {
                const msg =
                    `Send RESTART to ALL PCs (${pcs.length} total)?

All users on those machines will be impacted.`;
                if (!confirm(msg)) return;
                try {
                    await Promise.all(pcs.map(pc => apiPost('/pc/restart', { Name: pc.Name })));
                    showToast(`Restart sent to ${pcs.length} PC(s).`);
                } catch (err) {
                    console.error(err);
                    showToast('Failed to restart one or more PCs.', true);
                }
            });

            const allShutdownBtn = document.createElement('button');
            allShutdownBtn.className = 'btn btn-danger btn-small';
            allShutdownBtn.textContent = 'Shutdown';
            allShutdownBtn.addEventListener('click', async () => {
                const msg =
                    `⚠ WARNING ⚠

You are about to SHUT DOWN ALL PCs (${pcs.length} total).

Any unsaved work on those machines will be lost.

Proceed with shutdown of ALL PCs?`;
                if (!confirm(msg)) return;
                try {
                    await Promise.all(pcs.map(pc => apiPost('/pc/shutdown', { Name: pc.Name })));
                    showToast(`Shutdown sent to ${pcs.length} PC(s).`);
                } catch (err) {
                    console.error(err);
                    showToast('Failed to shutdown one or more PCs.', true);
                }
            });

            allActions.appendChild(allRestartBtn);
            allActions.appendChild(allShutdownBtn);

            allCard.appendChild(allName);
            allCard.appendChild(allDesc);
            allCard.appendChild(allActions);

            pcGrid.appendChild(allCard);

            // Individual PC cards
            for (const pc of pcs) {
                const card = document.createElement('div');
                card.className = 'pc-card';

                const nameEl = document.createElement('div');
                nameEl.className = 'pc-name';
                nameEl.textContent = pc.Name;

                const ipEl = document.createElement('div');
                ipEl.className = 'pc-ip';
                ipEl.textContent = pc.IP;

                const actions = document.createElement('div');
                actions.className = 'pc-actions';

                const restartBtn = document.createElement('button');
                restartBtn.className = 'btn btn-ghost btn-small';
                restartBtn.textContent = 'Restart';
                restartBtn.addEventListener('click', async () => {
                    const msg = `Send RESTART to PC "${pc.Name}" (${pc.IP})?\n\nAll users on that PC will be impacted.`;
                    if (!confirm(msg)) return;
                    try {
                        const resp = await apiPost('/pc/restart', { Name: pc.Name });
                        showToast(resp || `Restart sent to "${pc.Name}".`);
                    } catch (err) {
                        console.error(err);
                        showToast(`Failed to restart "${pc.Name}".`, true);
                    }
                });

                const shutdownBtn = document.createElement('button');
                shutdownBtn.className = 'btn btn-danger btn-small';
                shutdownBtn.textContent = 'Shutdown';
                shutdownBtn.addEventListener('click', async () => {
                    const msg =
                        `⚠ WARNING ⚠

You are about to SHUT DOWN PC "${pc.Name}" (${pc.IP}).

Any unsaved work on that machine will be lost.

Proceed with shutdown?`;
                    if (!confirm(msg)) return;
                    try {
                        const resp = await apiPost('/pc/shutdown', { Name: pc.Name });
                        showToast(resp || `Shutdown sent to "${pc.Name}".`);
                    } catch (err) {
                        console.error(err);
                        showToast(`Failed to shutdown "${pc.Name}".`, true);
                    }
                });

                actions.appendChild(restartBtn);
                actions.appendChild(shutdownBtn);

                card.appendChild(nameEl);
                card.appendChild(ipEl);
                card.appendChild(actions);

                pcGrid.appendChild(card);
            }
        }

        async function loadPcs() {
            try {
                const pcs = await apiGet('/pcs');
                pcsCache = pcs || []; // ✅ cache for IP -> Name mapping
                renderPcs(pcs);
            } catch (err) {
                console.error(err);
                showToast('Failed to load PCs list.', true);
            }
        }

        // Initial load
        (async function init() {
            setView('apps');
            await Promise.allSettled([loadPcs(), loadApps()]);
        })();
    </script>

</body>
</html>
